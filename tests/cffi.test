# (c) 2021 Ashok P. Nadkarni
# See LICENSE for license terms.
#
# This file contains basic version and configuration tests

source [file join [file dirname [info script]] common.tcl]

namespace eval ${NS}::test {
    # version
    test version-0 {Version check} -body {
        uplevel #0 package require cffi
    } -result 1.0b6

    # pkgconfig
    test pkgconfig-list-0 {pkgconfig list} -body {
        lsort [cffi::pkgconfig list]
    } -result {backend compiler version}
    test pkgconfig-get-0 {pkgconfig get version} -body {
        cffi::pkgconfig get version
    } -result [uplevel #0 package require cffi]
    test pkgconfig-get-1 {pkgconfig get compiler} -body {
        catch {cffi::pkgconfig get compiler}
    } -result 0
    test pkgconfig-get-2 {pkgconfig get backend} -body {
        expr {[cffi::pkgconfig get backend] in {libffi dyncall}}
    } -result 1

    # limits
    testnumargs limits cffi::limits TYPE
    # Assumes 1/2/4/8 byte integers
    foreach type [array names intMax] {
        test limits-$type-0 "limits $type" -body {
            cffi::limits $type
        } -result [list $intMin($type) $intMax($type)]
    }
    foreach type [concat $voidTypes $realTypes $stringTypes $charArrayTypes $pointerTypes] {
        test limits-$type-error-0 "limits $type - error" -body {
            cffi::limits $type
        } -result {Invalid or non-integral type specified.} -returnCodes error
    }

    # Test interp deletion - just to ensure no crashes
    test interp-deletion-0 "Verify interpreter deletion" -body {
        for {set i 0} {$i < 10} {incr i} {
            set ip [interp create]
            $ip eval [list set testdir [file dirname [info script]]]
            $ip eval {
                set argv ""
                source "$testdir/common.tcl"
                ::cffi::test::testDll function int_to_int int {i int}
                ::cffi::Struct create S {i int}
                ::cffi::alias define INT int
                ::cffi::enum define E {a 1}
            }
            interp delete $ip
        }
    } -result ""
}

::tcltest::cleanupTests
namespace delete cffi::test
